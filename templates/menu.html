<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ | Helader√≠a Annia</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/menu.css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/logo_01.jpeg') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body>
    <!-- NAV SUPERIOR -->
    <nav class="barra-navegacion d-flex justify-content-between align-items-center px-4 py-2">
        <a href="{{ url_for('home') }}" class="logo-link">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo Helader√≠a Annia" class="logo">
        </a>
        <!-- *** MEN√ö DEPENDIENDO DE LA SESI√ìN *** -->
        <div class="d-flex align-items-center gap-3">
            {% if not session.get('usuario_nombre') %}
                <!-- SI NO HAY SESI√ìN -->
                <a href="{{ url_for('registro') }}" class="btn" style="background-color:#947bf6ff;color:white;">Registrarse</a>
                <a href="{{ url_for('login') }}" class="btn" style="background-color:#f64d8eff;color:white;">Iniciar sesi√≥n</a>
            {% else %}
                <!-- SI HAY SESI√ìN -->
                <span style="font-weight:bold; color:#147D7D; font-size:1.1em;">
                    Hola, {{ session['usuario_nombre'] }}
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">Cerrar sesi√≥n</a>
            {% endif %}

            <!--  CONTADOR -->
            <span id="carritoCount" style="
                /* Fondo de color rosa */
                background:#F54388; 
                /*color para el texto */
                color:white; 
                /* Relleno interno (padding): 3px vertical, 8px horizontal */
                padding:3px 8px;
                /* Redondea las esquinas del contenedor */
                border-radius:12px;
                /* Hace que el n√∫mero (0) sea negrita */
                font-weight:bold;
            ">0</span>
        </div>
    </nav>

    <!-- SEGUNDA BARRA DE MEN√ö -->
    <header class="py-2 shadow-sm" style="background:#9a6759;">
        <nav class="container">
            <ul class="d-flex justify-content-center gap-4 list-unstyled m-0">
                <li><a href="{{ url_for('home') }}">Inicio</a></li>
                <li><a href="{{ url_for('menu') }}">Men√∫</a></li>
                <li><a href="{{ url_for('acerca') }}">Acerca de</a></li>
                <li><a href="{{ url_for('contacto') }}">Contacto</a></li>
            </ul>
        </nav>
    </header>
    <main style="background-color: #ffffffff; padding: 40px 20px;">
        <section id="Menu" class="container text-center">
            <h2 style="color: #F54388; font-size: 2.5em; margin-bottom: 10px;">Nuestro Men√∫</h2>
            <p style="color: #147D7D; font-style: italic; font-size: 1.1em; margin-bottom: 40px;">Disfruta nuestras delicias fr√≠as: helados, copas, malteadas y m√°s. ¬°Hechos con amor y sabor artesanal!</p>

<div class="menu-grid">
    {% for p in productos %}
    <article class="card">
        <!-- Imagen -->
        <div class="card-image-container">
            <img src="{{ url_for('static', filename='img/' + p.Imagen) }}"
                 alt="{{ p.Nombre_producto }}"
                 class="card-image">
        </div>

        <!-- Contenido -->
        <div class="card-content">
            <h3>{{ p.Nombre_producto }}</h3>
            <p>{{ p.Descripci√≥n }}</p>
            <span class="precio">${{ p.Precio_producto }}</span>
<!-- Dropdown din√°micos seg√∫n Numero_bolas -->
{% for i in range(1, p.Numero_bolas + 1) %}
    <label for="sabor-{{ p.Id_producto }}-{{ i }}">Sabor {{ i }}:</label>
    <select id="sabor-{{ p.Id_producto }}-{{ i }}" class="select-sabor">
        {% for s in sabores %}
        <option value="{{ s.Nombre_sabor }}">{{ s.Nombre_sabor }}</option>
        {% endfor %}
    </select>
{% endfor %}

            <!-- BOT√ìN DE AGREGAR -->
            <button class="btn-agregar"
                onclick="agregarAlCarrito('{{ p.Id_producto }}', '{{ p.Nombre_producto }}', {{ p.Precio_producto }}, {{ p.Numero_bolas }})">
                <i class="bi bi-basket2-fill"></i> Agregar
            </button>
        </div>
    </article>
    {% endfor %}
</div>
        </section>
    </main>

    <!-- CARRITO FLOTANTE -->
    <a href="#" id="carritoFlotante" data-bs-toggle="modal" data-bs-target="#modalCarrito" style="background-color: #147D7D;">
        <i class="bi bi-basket2-fill"></i>
        <span id="carritoCountFloat" style="background-color: #F54388;">0</span>
    </a>

    <!-- MODAL DEL CARRITO -->
    <div class="modal fade" id="modalCarrito" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header" style="background-color: #FCEA85; color: #147D7D;">
                    <h5 class="modal-title">Mi Carrito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" id="listaCarrito">
                    <p>Tu carrito est√° vac√≠o üç¶</p>
                </div>

                <!--  BOT√ìN CORREGIDO -->
                <div class="modal-footer">
                    <button class="btn" style="background-color: #F54388; color: white;" onclick="validarCompra()">
                        Comprar
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL LOGIN -->
    <div class="modal fade" id="modalLogin" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #B5EFCC; color: #147D7D;">
                    <h5 class="modal-title">Debes iniciar sesi√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Para poder comprar debes iniciar sesi√≥n en tu cuenta.
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('login') }}" class="btn" style="background-color: #147D7D; color: white;">Iniciar Sesi√≥n</a>
                </div>
            </div>
        </div>
    </div>

    <footer style="background-color: #FCEA85; color: #147D7D;">
        <p>&copy; 2025 Helader√≠a Annia. Todos los derechos reservados.</p>
    </footer>

    <!-- ‚úî VARIABLE DE SESI√ìN CORREGIDA -->
<script>
const usuarioLogueado = "{{ 'true' if session.get('usuario_nombre') else 'false' }}" === "true";
let carrito = [];

const carritoCount = document.getElementById("carritoCount");
const carritoCountFloat = document.getElementById("carritoCountFloat");
const listaCarrito = document.getElementById("listaCarrito");

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ AGREGAR PRODUCTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agregarAlCarrito(idProducto, nombre, precio, numeroBolas) {

    let sabores = [];

    // Leer cada sabor seg√∫n numeroBolas
    for (let i = 1; i <= numeroBolas; i++) {
        let selectId = `sabor-${idProducto}-${i}`;
        let sabor = document.getElementById(selectId).value;
        sabores.push(sabor);
    }

    carrito.push({
        nombre,
        precio,
        sabores
    });

    actualizarContadores();
    renderCarrito();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ELIMINAR PRODUCTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function eliminarProducto(index) {
    carrito.splice(index, 1);
    actualizarContadores();
    renderCarrito();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONTADORES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function actualizarContadores() {
    carritoCount.textContent = carrito.length;
    carritoCountFloat.textContent = carrito.length;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ RENDER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCarrito() {
    if (carrito.length === 0) {
        listaCarrito.innerHTML = "<p>Tu carrito est√° vac√≠o üç¶</p>";
        return;
    }

    listaCarrito.innerHTML = carrito.map((item, index) => {
        let saboresHTML = item.sabores.map((s, i) => `<br>Sabor ${i+1}: ${s}`).join("");

        return `
        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
            <div>
                <strong>${item.nombre}</strong> ‚Äî $${item.precio}
                ${saboresHTML}
            </div>
            <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">
                <i class="bi bi-trash3-fill"></i>
            </button>
        </div>`;
    }).join("");
}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VALIDAR SI EST√Å LOGUEADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function validarCompra() {
    if (!usuarioLogueado) {
        const loginModal = new bootstrap.Modal(document.getElementById("modalLogin"));
        loginModal.show();
        return;
    }

    comprar();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ COMPRAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function comprar() {

    if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o");
        return;
    }

    // Guardar en localStorage para usarlo en confirmar_pedido.html
    localStorage.setItem("carrito", JSON.stringify(carrito));
    const total = carrito.reduce((suma, p) => suma + p.precio, 0);
    localStorage.setItem("total", total);
    localStorage.setItem("usuario", "{{ session.get('usuario_nombre') }}");

    // Redirigir a la p√°gina de confirmar pedido
    window.location.href = "/confirmar_pedido";
}

</script>
</body>
</html>