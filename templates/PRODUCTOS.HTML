<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos</title>
    
    <link rel="stylesheet" href="../static/css/productos.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body> 
    <!--  sección de encabezado  -->
    <div class="header-section">
        <h1>Gestión de productos</h1>
        <a href="{{ url_for('admin_panel') }}" class="nav-link">Volver al inicio</a>
    </div>
    <!--  tarjetas de resumen  -->
    <div class="cards">
        <div class="card">
            <h3>Productos activos</h3>
            <p>5</p>
        </div>
        <div class="card">
            <h3>Pedidos hoy</h3>
            <p>12</p>
        </div>
        <div class="card">
            <h3>Ingresos estimados</h3>
            <p>$320.000</p>
        </div>
    </div>
    <!--  contenedor principal  -->
    <div class="contenedor-principal">
        <div class="tabla-contenedor">
            <h2>Lista de sabores</h2>
            <table border="1">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Categoría</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productos-tbody">
                    <tr>
                        <td>Vainilla</td>
                        <td>$4.500</td>
                        <td>20</td>
                        <td>Clásico</td>
                        <td>
                            <button class="action-btn editar" data-id="1">Editar</button>
                            <button class="action-btn eliminar" data-id="1">Eliminar</button>
                        </td>
                    </tr>
                    <tr>
                        <td>Chocolate</td>
                        <td>$4.800</td>
                        <td>15</td>
                        <td>Clásico</td>
                        <td>
                            <button class="action-btn editar" data-id="2">Editar</button>
                            <button class="action-btn eliminar" data-id="2">Eliminar</button>
                        </td>
                    </tr>
                    <tr>
                        <td>Fresa</td>
                        <td>$4.700</td>
                        <td>8</td>
                        <td>Premium</td>
                        <td>
                            <button class="action-btn editar" data-id="3">Editar</button>
                            <button class="action-btn eliminar" data-id="3">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!--  formulario para añadir productos  -->
        <div class="formulario-contenedor">
            <h3>Añadir producto</h3>
            <form id="form-agregar-producto">
                <label for="nombre">Nombre</label>
                <input type="text" id="nombre" name="nombre" required><br><br>

                <label for="precio">Precio (COP)</label>
                <input type="number" id="precio" name="precio" required min="0"><br><br>

                <label for="stock">Stock</label>
                <input type="number" id="stock" name="stock" required min="0"><br><br>

                <label for="categoria">Categoría</label>
                <select id="categoria" name="categoria">
                    <option value="Clásico">Clásico</option>
                    <option value="Premium">Premium</option>
                    <option value="Vegano">Vegano</option>
                </select><br><br>
                <button type="submit" class="agregar">Agregar producto</button>
            </form>
        </div>
    </div>
    
    <div id="custom-modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button id="modal-accept-btn" class="modal-primary-btn">Aceptar</button> 
        </div>
    </div>

    <script>
        // Función para mostrar el modal personalizado (Maneja avisos y confirmaciones)
        function showCustomModal(message, isConfirmation = false, onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalBtn = document.getElementById('modal-accept-btn');
            
            // Oculta el modal antes de configurarlo, asegurando que inicie invisible
            modal.style.display = 'none'; 

            modalMessage.textContent = message;
            
            // Clonar el botón para limpiar listeners anteriores
            const oldModalBtn = modalBtn.cloneNode(true);
            modalBtn.parentNode.replaceChild(oldModalBtn, modalBtn);
            const newModalBtn = modal.querySelector('#modal-accept-btn');
            newModalBtn.className = 'modal-primary-btn'; // Asegura la clase CSS principal

            let cancelButton = null;
            // Asegurarse de que no haya botón de cancelar sobrante del ciclo anterior
            if (modal.querySelector('.modal-content .modal-cancel-btn')) {
                modal.querySelector('.modal-content .modal-cancel-btn').remove();
            }


            if (isConfirmation) {
                // Configuración para confirmación (Eliminar)
                newModalBtn.textContent = "Aceptar";
                
                cancelButton = document.createElement('button');
                cancelButton.textContent = "Cancelar";
                cancelButton.className = 'modal-cancel-btn'; // Clase CSS para el botón Cancelar
                
                // Añadir el botón de cancelar después del botón principal
                newModalBtn.parentNode.appendChild(cancelButton);

                // Manejar la confirmación
                newModalBtn.addEventListener('click', function handler() {
                    if (onConfirm) onConfirm(true);
                    hideModal();
                    if (cancelButton) cancelButton.removeEventListener('click', hideModal);
                }, { once: true });
                
                cancelButton.addEventListener('click', hideModal, { once: true });
                
            } else {
                // Configuración para aviso simple (Agregar, Validar)
                newModalBtn.textContent = "Aceptar"; // Texto del botón para avisos
                newModalBtn.addEventListener('click', hideModal, { once: true }); // Cierra el modal al hacer clic
            }


            // Función para ocultar el modal
            function hideModal() { // Cierra el modal
                modal.style.display = 'none';
                
                if (cancelButton && cancelButton.parentNode) {
                    cancelButton.parentNode.removeChild(cancelButton);
                }
            }

            modal.style.display = 'flex'; // Muestra el modal
        }

        document.addEventListener("DOMContentLoaded", () => {
            // 1. Obtener elementos clave
            const formAgregarProducto = document.getElementById("form-agregar-producto");
            const tablaBody = document.getElementById("productos-tbody");

            let nextId = 4; 
            
            const getInputValue = (id) => document.getElementById(id).value;
            
            const formatPrice = (price) => {
                return price.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            };

            // ------------------------------------
            // 2. Lógica para AGREGAR producto (Evento 'submit')
            // ------------------------------------
            if (formAgregarProducto) {
                formAgregarProducto.addEventListener("submit", (e) => {
                    e.preventDefault(); 
                    // Obtener y validar datos del formulario
                    const nombre = getInputValue("nombre").trim();
                    const precio = parseFloat(getInputValue("precio"));
                    const stock = parseInt(getInputValue("stock"));
                    const categoria = getInputValue("categoria");

                    if (!nombre || isNaN(precio) || isNaN(stock) || precio <= 0 || stock < 0) {
                        showCustomModal("Por favor, completa todos los campos con valores válidos.");
                        return;
                    }
                    // Crear nueva fila en la tabla
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                        <td>${nombre}</td>
                        <td>$${formatPrice(precio)}</td>
                        <td>${stock}</td>
                        <td>${categoria}</td>
                        <td>
                            <button class="action-btn editar" data-id="${nextId}">Editar</button>
                            <button class="action-btn eliminar" data-id="${nextId}">Eliminar</button>
                        </td>
                    `;

                    tablaBody.appendChild(fila);
                    nextId++; 
                    formAgregarProducto.reset();
                    attachActionListeners(fila);

                    showCustomModal(`Producto "${nombre}" agregado correctamente.`);
                });
            }

            // ------------------------------------
            // 3. Lógica para EDITAR / ELIMINAR
            // ------------------------------------

            function startEditing(row) {
                const cells = Array.from(row.querySelectorAll("td:not(:last-child)"));
                const originalValues = cells.map(cell => cell.textContent.trim());
                row.dataset.originalValues = JSON.stringify(originalValues);

                const fieldNames = ["nombre", "precio", "stock", "categoria"];
                // Reemplazar celdas con inputs
                cells.forEach((cell, index) => {
                    const currentValue = originalValues[index];
                    let inputElement;
                    let displayValue = currentValue;

                    if (fieldNames[index] === "precio") {
                        displayValue = currentValue.replace('$', '').replace(/\./g, ''); 
                    }

                    if (fieldNames[index] === "categoria") {
                        inputElement = document.createElement("select");
                        inputElement.innerHTML = `
                            <option value="Clásico" ${currentValue === 'Clásico' ? 'selected' : ''}>Clásico</option>
                            <option value="Premium" ${currentValue === 'Premium' ? 'selected' : ''}>Premium</option>
                            <option value="Vegano" ${currentValue === 'Vegano' ? 'selected' : ''}>Vegano</option>
                        `;
                    } else {
                        inputElement = document.createElement("input");
                        inputElement.value = displayValue; 
                        inputElement.type = (fieldNames[index] === "stock" || fieldNames[index] === "precio") ? "number" : "text";
                    }
                    
                    // Añadimos la clase CSS para los inputs de edición
                    inputElement.className = 'edit-input'; 

                    cell.innerHTML = ''; 
                    cell.appendChild(inputElement);
                });
                // Actualizar los botones de acción
                const editButton = row.querySelector(".editar");
                const deleteButton = row.querySelector(".eliminar");
                
                editButton.textContent = "Guardar";
                deleteButton.textContent = "Cancelar";
                deleteButton.classList.remove('eliminar');
                deleteButton.classList.add('cancelar'); 

                attachActionListeners(row);
            }
            //  Función para guardar los cambios después de editar
            function saveEditing(row) {
                const cells = Array.from(row.querySelectorAll("td:not(:last-child)"));
                let isValid = true;
                
                cells.forEach((cell, index) => {
                    const input = cell.querySelector('input, select');
                    let newValue = input.value.trim();
                    
                    if (index === 1 || index === 2) { 
                        if (isNaN(parseFloat(newValue)) || parseFloat(newValue) < 0) {
                            showCustomModal('El precio y el stock deben ser números válidos y positivos.');
                            isValid = false;
                            return;
                        }
                    }
                    
                    if (isValid) {
                        if (index === 1) { 
                            newValue = `$${formatPrice(parseFloat(newValue))}`;
                        }
                        
                        cell.innerHTML = newValue;
                    }
                });
                //  Si todos los datos son válidos, actualizar los botones y listeners
                if (isValid) {
                    const editButton = row.querySelector(".editar");
                    const cancelButton = row.querySelector(".cancelar");
                    
                    editButton.textContent = "Editar";
                    
                    cancelButton.textContent = "Eliminar";
                    cancelButton.classList.remove('cancelar');
                    cancelButton.classList.add('eliminar');
                    
                    attachActionListeners(row);
                    showCustomModal(`Producto con ID ${editButton.dataset.id} actualizado.`);
                }
            }
            //  Función para cancelar la edición y restaurar los valores originales
            function cancelEditing(row, cancelButton) {
                const originalValues = JSON.parse(row.dataset.originalValues);
                const cells = Array.from(row.querySelectorAll("td:not(:last-child)"));
                const editButton = row.querySelector(".editar");

                cells.forEach((cell, index) => {
                    cell.innerHTML = originalValues[index]; 
                });

                editButton.textContent = "Editar";
                
                cancelButton.textContent = "Eliminar";
                cancelButton.classList.remove('cancelar');
                cancelButton.classList.add('eliminar');

                attachActionListeners(row);
            }
            //  Función para adjuntar listeners a los botones de acción en una fila
            function attachActionListeners(row) {
                const actionsCell = row.querySelector('td:last-child');
                const existingEdit = actionsCell.querySelector('.editar');
                const existingDelete = actionsCell.querySelector('.eliminar, .cancelar');
                
                if (existingEdit) {
                    const newEdit = existingEdit.cloneNode(true);
                    existingEdit.parentNode.replaceChild(newEdit, existingEdit);
                    
                    newEdit.addEventListener("click", function() {
                        if (this.textContent === "Editar") {
                            startEditing(row);
                        } else if (this.textContent === "Guardar") {
                            saveEditing(row);
                        }
                    });
                }
                //  Manejo del botón Eliminar / Cancelar
                if (existingDelete) {
                    const newDelete = existingDelete.cloneNode(true);
                    existingDelete.parentNode.replaceChild(newDelete, existingDelete);
                    
                    newDelete.addEventListener("click", function() {
                        if (this.textContent === "Eliminar") {
                            const productId = this.dataset.id;
                            showCustomModal(`¿Estás seguro de que deseas eliminar el producto con ID ${productId}?`, true, (confirmed) => {
                                if (confirmed) {
                                    row.remove();
                                    showCustomModal(`Producto con ID ${productId} eliminado.`);
                                }
                            });
                        } else if (this.textContent === "Cancelar") {
                             cancelEditing(row, this);
                        }
                    });
                }
            }
            // Adjuntar listeners a las filas existentes al cargar la página
            if (tablaBody) {
                tablaBody.querySelectorAll("tr").forEach(row => {
                    attachActionListeners(row);
                });
            }
        });
    </script>
    </body>
</html>